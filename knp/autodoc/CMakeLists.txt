cmake_minimum_required(VERSION 3.25)

list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/cmake")

project(knp-autodoc
        VERSION "${KNP_VERSION}"
        DESCRIPTION "Kaspersky Neuromorphic Platform Doxygen autogenerated documentation"
        HOMEPAGE_URL "https://neuro.kaspersky.ru/neyromorfnye-tekhnologii/")
set(KNP_BUILD_DOCUMENTATION OFF)
if(KNP_BUILD_DOCUMENTATION)
    set(DOXYFILE_IN "${CMAKE_CURRENT_SOURCE_DIR}/Doxyfile.in")
    file(REAL_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../../knp" SOURCE_ROOT_DIR)

    message(DEBUG "Source root directory: ${SOURCE_ROOT_DIR}")

    include("doxygen")

    message(STATUS "Generating documentation...")

    foreach(_i
            core-library base-framework devices-library meta-library
            neuron-traits-library synapse-traits-library
            backends/cpu/cpu-single-threaded-backend
            backends/cpu/cpu-multi-threaded-backend
            backends/cpu/thread_pool
        )
        list(APPEND _strip_list "${SOURCE_ROOT_DIR}/${_i}/include")
    endforeach()

    list(APPEND _strip_list "${SOURCE_ROOT_DIR}")

    autodoc_add_doxygen(${PROJECT_NAME} "${DOXYFILE_IN}"
        PROJECT_NAME "Kaspersky Neuromorphic Platform"
        PROJECT_VERSION "${PROJECT_VERSION}"
        PROJECT_BRIEF "API Reference"
        OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/doc_doxygen"
        INPUT "${SOURCE_ROOT_DIR}"
        EXAMPLE_PATH "${SOURCE_ROOT_DIR}/tests"
        SOURCE_BROWSER YES
        BUNDLE_ID "com.kaspersky.KNP"
        PUBLISHER_NAME "Kaspersky Lab"
        EXCLUDE_PATTERNS "*.descr* */impl/* */tests/*"
        EXCLUDE_SYMBOLS "*impl*, *testing*"
        STRIP_FROM_INC_PATH "${_strip_list}"
    )
    # Automatically build doc.
    add_dependencies(knp-core ${PROJECT_NAME})

    autodoc_get_files_and_dir("${CMAKE_BINARY_DIR}/doc_doxygen/html" DOC_DIRS DOC_FILES)

    install(DIRECTORY
            ${DOC_DIRS}
            COMPONENT "documentation"
            DESTINATION "${CMAKE_INSTALL_DOCDIR}/html/reference")
    install(FILES
            ${DOC_FILES}
            COMPONENT "documentation"
            DESTINATION "${CMAKE_INSTALL_DOCDIR}/html/reference")
else()
    message(STATUS "Documentation generating disabled.")
endif()
