cmake_minimum_required(VERSION 3.22) # TODO: increase to 3.25

list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/cmake")

project(knp-autodoc
        VERSION "${KNP_VERSION}"
        DESCRIPTION "Kaspersky Neuromorphic Platform Doxygen autogenerated documentation"
        HOMEPAGE_URL "https://neuro.kaspersky.ru/neyromorfnye-tekhnologii/")

set(DOXYFILE_IN "${CMAKE_CURRENT_SOURCE_DIR}/Doxyfile.in")
file(REAL_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../../knp" KNP_DIR)

message(DEBUG "KNP directory: ${KNP_DIR}")

if(KNP_BUILD_DOCUMENTATION)
    message(STATUS "Generating documentation...")
    include("doxygen")
    foreach(_i
            core-library base-framework
            neuron-traits-library synapse-traits-library
            devices-library
            backends/cpu/cpu-single-threaded-backend
            backends/cpu/cpu-multi-threaded-backend
            backends/cpu/thread_pool
        )
        list(APPEND _strip_list "${KNP_DIR}/${_i}/include")
    endforeach()

    list(APPEND _strip_list "${KNP_DIR}")

    add_doxygen(${PROJECT_NAME} "${DOXYFILE_IN}"
        PROJECT_NAME "Kaspersky Neuromorphic Platform"
        PROJECT_VERSION "${KNP_VERSION}"
        PROJECT_BRIEF "API Reference"
        OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/doc_doxygen"
        INPUT "${KNP_DIR}"
        EXAMPLE_PATH "${KNP_DIR}/tests"
        SOURCE_BROWSER YES
        BUNDLE_ID "com.kaspersky.KNP"
        PUBLISHER_NAME "Kaspersky Lab"
        EXCLUDE_PATTERNS "*.descr* */impl/* */tests/*"
        EXCLUDE_SYMBOLS "*impl*, *testing*"
        STRIP_FROM_INC_PATH "${_strip_list}"
    )
    # Automatically build doc.
    add_dependencies(knp-core ${PROJECT_NAME})

    install(DIRECTORY
            "${CMAKE_BINARY_DIR}/doc_doxygen/html"
            COMPONENT "documentation"
#            TYPE DOC
            DESTINATION "${CMAKE_INSTALL_DOCDIR}/html/doxygen")
else()
    message(STATUS "Documentation generating disabled.")
endif()
